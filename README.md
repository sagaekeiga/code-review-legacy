<!-- this document is auto-generated by irodori rails application template -->

# Mergee

コードレビューサービス

<!-- ---------------------------------------------------------------------------------->

## 環境構築

### Docker のインストール

[Docker for Mac の Stable 版](https://download.docker.com/mac/stable/Docker.dmg)をインストールしてください。
ログインが必要な場合は https://store.docker.com/editions/community/docker-ce-desktop-mac から。

### 環境変数の設定

dotenv-rails 経由で環境変数を読み込むようにしていますので、サンプルファイルをコピーして各自の設定をしてください。

```shell
cp dotenv.sample .env

# 各環境に合わせたAPIキー等の設定をする。詳細はdotenv.sampleを参照。
vim .env
```

### Docker Container の起動

初回

```shell
docker-compose build
docker-compose run web yarn add postcss-loader sass-loader
docker-compose run web yarn install
docker-compose run --rm web bundle exec rails db:create db:migrate db:seed app:dev:sample
docker-compose up
```

二回目以降

```shell
docker-compose build
docker-compose run web yarn
docker-compose run --rm web bundle exec rails db:create db:migrate db:seed app:dev:sample
docker-compose up
```

### Pow との連携

domain 制約をつけているので、以下で pow と連携

```shell
echo '13008' > ~/.pow/mergee
```

13008 が競合する場合は適宜変更してください（その際、docker-compose.yml で rails server で指定している引数も変更してください）

<!-- ---------------------------------------------------------------------------------->

## SSL でのアクセス

Facebook Login の callback URL 等、開発時でも SSL が必須になってくるケースが増えているので tunnelss を使って.test でアクセスしたときに HTTPS も対応できるようにしておく。

```
gem install tunnelss
sudo tunnelss
```

これで https://unplan-checkin.test でアクセスできるようになる。

また、 ~/.tunnelss/cert.pem を keychain にインポートし、「常に信頼」しておくとブラウザでアクセスしたときにアラートも出ない。

<!-- ---------------------------------------------------------------------------------->

## テスト方法

```shell
docker-compose run --rm web bundle exec rspec
```

<!-- ---------------------------------------------------------------------------------->

## リリース手順

### Elastic Beanstalk へのデプロイ

#### 1. Docker iamge を build

```
docker build \
  -t ${ECR_REPOSITORY_NAME} \
  -f eb/Dockerfile \
  --build-arg AWS_ACCESS_KEY_ID="..." \
  --build-arg AWS_SECRET_ACCESS_KEY="..." \
  .
```

#### 2. AWS CLI でログイン

```
aws ecr get-login --no-include-email --region ap-northeast-1 --profile ${your-aws-profile-name} | sh
```

#### 3. タグづけ&デプロイ

```
docker tag ${ECR_REPOSITORY_NAME}:latest ${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-1.amazonaws.com/${ECR_REPOSITORY_NAME}:latest
docker push ${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-1.amazonaws.com/${ECR_REPOSITORY_NAME}:latest
```

このあたりは CircleCI 上から実行も可能

### Heroku へのデプロイ（直接 Git に push するパターン）

```shell
git push staging master
git push production master
```

### Heroku へのデプロイ（pipeline を利用するパターン）

Heroku Pipeline の詳細は以下の URL を参考にしてください
[Pipelines](https://devcenter.heroku.com/articles/pipelines)

```shell
# 以下のコマンドでcliからpipelineを叩けるようにしておいてください
# heroku plugins:install heroku-pipelines
heroku pipelines:promote -r staging -t production
```

<!-- ---------------------------------------------------------------------------------->

## 注意事項

`@TODO プロジェクトを進めるにあたっての注意事項を記載してください。`
