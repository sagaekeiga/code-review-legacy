.col-xs-12
  .page-header{ 'pull-id': @pull.id }
    %h3= @pull.title
  = render 'reviewers/shared/tab', pull: @pull, changed_files: @changed_files

  = form_for [:reviewers, @pull, @review], html: { class: 'form-horizontal', role: 'form' } do |f|
    .data_id{ 'pull-id': @pull.id, 'reviewer-id': current_reviewer.id }
    .reviews-form-wrapper
      .reviews-form-card-wrapper
        - @changed_files.each do |changed_file|
          .js-blob-wrapper
            .card.changed-file-list-wrapper
              .card-header.changed-file-name= changed_file.filename
              .card-body.file-border{ 'changed-file-id': changed_file.id }
                .card-text
                  .table-wrapper
                    %table
                      %thead
                        %tr
                          %th{ scope: 'col' }
                      %tbody
                        - changed_file.patch&.each_line&.with_index do |line, index|
                          %tr.code-tr{ 'data-line-number': index }
                            - if line.start_with?('+')
                              %td.markdown-highlight.bg-success.hljs-addition.file-code= changed_file.coderay(line)
                            - elsif line.start_with?('-')
                              %td.markdown-highlight.bg-danger.hljs-addition.file-code= changed_file.coderay(line)
                            - elsif line.start_with?('@@')
                              %td.markdown-highlight.bg-primary.hljs-addition.file-code
                                %pre= line
                            - else
                              %td.markdown-highlight.hljs-addition.file-code= changed_file.coderay(line)
                          - review_comment = changed_file.review_comments.find_by(position: index)
                          - if changed_file.present_review_comment?(index)
                            %tr
                              %td
                                .review-comments-wrapper
                                  .card
                                    - if review_comment.pending?
                                      .card-header
                                        %span.label.label-warning Pending
                                    .card-body
                                      -# @TODO アイコン追加
                                      -# - if changed_file.reviewer?(index)
                                      -#   = image_tag current_reviewer.github_account.avatar_url, class: 'float-left', style: 'width: 50px;'
                                      .card-text{ 'review-comment-id': changed_file.review_comment_id(index) }
                                        = markdown(changed_file.review_comment_body(index))
                                      - if changed_file.reviewer?(index)
                                        .flex-row.text-right
                                          %button{ type: 'button', class: 'btn btn-danger card-link destroy-trigger', data: { confirm: '本当によろしいですか？' } }
                                            %span.glyphicon.glyphicon-trash
                                          %button{ type: 'button', class: 'btn btn-primary card-link edit-trigger' }
                                            %span.glyphicon.glyphicon-pencil
                                          = hidden_field_tag 'reviews[changed_file_ids][]', changed_file.id, class: 'changed_file_id'
                                          = hidden_field_tag 'reviews[path][]', changed_file.review_comment_path(index), class: 'path'
                                          = hidden_field_tag 'reviews[position][]', changed_file.review_comment_position(index), class: 'position'
    %hr
    = f.label :body, for: 'review_body'
    = f.text_area :body, id: 'review_body', class: 'form-control', rows: '3', required: true
    %small.form-text.text-muted= t '.body_helper'
    .text-center
      = f.submit t('helpers.links.review'), id: 'submit_review_button', class: 'btn btn-primary'
      = image_tag 'loading.gif', class: 'loading hidden'

= javascript_pack_tag 'reviews'
