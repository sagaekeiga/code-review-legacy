.container
  .row
    .review
      .workspace
        .conversation-wrapper
          = render 'reviewers/reviews/progress_bar', pull: @pull, review: @review
          .page-header{ 'pull-id': @pull.id, 'repo-token': @pull.repo_token, 'issue-numbers': @numbers.empty? ? 0 : @numbers }
            %h1
              %strong= @pull.title
          .menu= render 'reviewers/reviews/menu', repo: @pull.repo, changed_files: @changed_files, commits: @commits, numbers: @numbers
          #conversationTab.tab-content.active
            - @reviews.each do |review|
              - if review.comment?
                -# 全体へのレビューコメント
                .review-wrapper
                  = render review
              - review.reviewed_comments.decorate.each.with_index do |review_comment, index|
                %li.step
                  = image_tag review_comment.step_image, class: 'step'
                  %span.path= review_comment.path
                  = review_comment.set_read_message
                  .comment-line
                    .panel.step{ class: review_comment.set_unread }
                      .panel-body
                        .code-wrapper
                          %table
                            %thead
                              %tr
                                %th{ scope: 'col' }
                            - review_comment.target_lines.each_with_index do |line, index|
                              %tbody
                                %tr
                                  %td.hidden= index
                                  - if line.start_with?('+')
                                    %td.markdown-highlight.bg-success.file-code= review_comment.changed_file.decorate.coderay(line)
                                  - elsif line.start_with?('-')
                                    %td.markdown-highlight.bg-danger.file-code= review_comment.changed_file.decorate.coderay(line)
                                  - elsif line.start_with?('@@')
                                    %td.markdown-highlight.bg-primary.file-code= simple_format(line)
                                  - else
                                    %td.markdown-highlight.file-code= review_comment.changed_file.decorate.coderay(line)
                        .panel-text
                          = render review_comment.target_comments
                      .panel-footer
                        .text-right
                          .menu.code-button{ 'repo-id': @pull.repo.id, 'changed-file-id': review_comment.changed_file.id }
                            %i.fas.fa-code
                          .menu.thread-button{ class: review_comment.set_active }
                            %i.far.fa-comments{ class: review_comment.set_active }
                      // Reply
                      .replies-wrapper
                        .panel
                          .panel-body{ class: review_comment.set_hidden(:replies) }
                            - if review_comment.replies.present?
                              = render review_comment.replies.includes(:comment, :reviewer)&.decorate
                          .panel-footer
                            .input
                              %textarea{ type: 'text', class: 'form-control' }
                            .submit
                              %button{ type: 'button', class: 'btn btn-primary reply-submit-btn' } 返信する
                              %input{ type: 'hidden', value: @pull.token, class: 'pull_token' }
                              %input{ type: 'hidden', value: review_comment.id, class: 'review_comment_id' }
                              %input{ type: 'hidden', value: review_comment.review.id, class: 'review_id' }
                              %input{ type: 'hidden', value: review_comment.path, class: 'path' }
                              %input{ type: 'hidden', value: review_comment.position, class: 'position' }
                              %input{ type: 'hidden', value: review_comment.changed_file.id, class: 'changed_file_id' }
                              %input{ type: 'hidden', value: review_comment.changed_file.commit_id, class: 'commit_id' }
                      // Contents
                      .code-wrapper.hidden
                        .panel
                          .table-wrapper
                            %table
                              %thead{ id: "code#{index}" }
                                %tr
                                  %th{ scope: 'col' }
            .bottom-line
          .m-t-10.m-b-4
            #codeTab.hidden.tab-content
              .reviews-form-wrapper
                .reviews-form-card-wrapper.editor
                  = render @changed_files
            = render 'reviewers/reviews/tab_contents', repo: @pull.repo, pull: @pull, commits: @commits, numbers: @numbers
= javascript_pack_tag 'issues'
= javascript_pack_tag 'review-tab'
= javascript_pack_tag 'reply'
= javascript_pack_tag 'changed-files'
